<html><head>
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<meta></head>
<body>
    <script type="text/javascript">
        let base64String = "";
        let fileName = "";

        loadHTML = function () {

            // now get the file from this...
            //https://romts-gsrst-dev-tcd365.crm3.dynamics.com/api/data/v9.0/ts_files(09f96aee-0f73-ec11-8942-000d3a0bf0a3)/ts_attachment/
            //https://www.w3schools.com/js/js_json_http.asp

            var attachmentGuid = "";

            //parent.Xrm.WebApi.retrieveRecord("ts_file", "6c0f8c95-0f73-ec11-8942-000d3a0bf0a3", "?$select=ts_attachment").then(
            //    function success(result) {
            //        attachmentGuid = result.ts_attachment
            //    },
            //    function (error) {
            //        console.log(error.message);
            //    }
            //);

            parent.Xrm.WebApi.retrieveRecord("contact", "261c6df5-27b5-ec11-983e-0022483dbf81", "?$select=lastname").then(
                function success(result) {
                    alert("Retrieved values: Last Name: " + result.lastname);
                },
                function (error) {
                    alert(error.message);
                }
            );


            //var emailActivityId = "9c5dd71b-b2c1-ec11-983e-0022483d701f";
            //var activityType = "email"

            //var entity = {};
            //entity["objectid_activitypointer@odata.bind"] = "/activitypointers(" + emailActivityId + ")";
            //entity.body = base64String
            //entity.filename = fileName;
            //entity.subject = "test";
            //entity.objecttypecode = activityType;

            //var req = new XMLHttpRequest();
            //req.open("POST", parent.Xrm.Page.context.getClientUrl() + "/api/data/v9.0/activitymimeattachments", true);
            //req.setRequestHeader("OData-MaxVersion", "4.0");
            //req.setRequestHeader("OData-Version", "4.0");
            //req.setRequestHeader("Accept", "application/json");
            //req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            //req.onreadystatechange = function () {
            //    if (this.readyState === 4) {
            //        req.onreadystatechange = null;
            //        if (this.status === 204) {
            //            var uri = this.getResponseHeader("OData-EntityId");
            //            var regExp = /\(([^)]+)\)/;
            //            var matches = regExp.exec(uri);
            //            var newEntityId = matches[1];
            //        } else {
            //            parent.Xrm.Utility.alertDialog(this.statusText);
            //        }
            //    }
            //};
            //req.send(JSON.stringify(entity));

            alert("We have lift off!");
        }


        window.onload = function () {
            // Get a reference to the file input
            var fileInput = document.getElementById('myFile');

            
            // Listen for the change event so we can capture the file
            fileInput.addEventListener('change', (e) => {
                // Get a reference to the file
                const file = e.target.files[0];

                fileName = file.name;

                // Encode the file using the FileReader API
                const reader = new FileReader();
                reader.onloadend = () => {
                    // Use a regex to remove data url part
                    base64String = reader.result
                        .replace('data:', '')
                        .replace(/^.+,/, '');

                    console.log(base64String);
                    // Logs wL2dvYWwgbW9yZ...

                    var fileName = reader.file
                };
                reader.readAsDataURL(file);
            });
        }
    </script>


    <input type="file" id="myFile">

    <button type="button" class="btn btn-default btn-lg" onclick="loadHTML()">
        <span class="glyphicon glyphicon-info-sign"></span>
    </button>

</body></html>